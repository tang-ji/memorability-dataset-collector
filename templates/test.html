<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Game</title>
    <style type="text/css">
      head{color:black; text-align: right;}
      .container h3{
        font-size: 14px;
        font-weight: 150;
        text-align: center;
      }
      form button{
        background: black;
        border: 0;
        padding: 5px 10px;
        color: white;
        border-radius: 8px;
        width: 70px;
        font-size: 14px;
      }
      form button:hover{
        background:#CCC;
      }
      body{color:black; text-align: center; background: #ffe577;}
      .context{
      position: center;
      left: 0;
      top:50%;
      width: 100%;
      height: 700px;
      margin-top: 0px;
      overflow: hidden;
      }
      .modal-header {
        padding: 2px 16px;
        background-color: #ffe8a7;
        color: white;
      }
      .modal-body {padding: 2px 16px;}
      /* Modal Footer */
      .modal-footer {
        padding: 2px 16px;
        background-color: #5cb85c;
        color: white;
      }
      .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      }
      .modal-content {
        position: relative;
        background-color: #fefefe;
        margin: auto;
        padding: 0;
        border: 1px solid #888;
        width: 50%;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        animation-name: animatetop;
        animation-duration: 0.4s
      }
      /* Add Animation */
      @keyframes animatetop {
        from {top: -300px; opacity: 0}
        to {top: 0; opacity: 1}
      }
      .container{
        max-width: 600px;
        height: 400px;
        padding: 0px 0;
        text-align: center;
        margin: 0 auto;
      }
      .img{
        width: 600px;
        height: 600px;
        text-align: center;
      }
      .container h1{
        font-size: 18px;
          font-weight: 300;}
      .container h2{
        font-size: 18px;
        font-weight: 150;
        font-family: consolas;
      }
      .container h4{
        font-size: 18px;
        font-weight: 150;
        text-align: left;
        font-family: consolas;
      }
      kbd {
        background-color: #eee;
        border-radius: 3px;
        border: 1px solid #b4b4b4;
        box-shadow: 0 1px 1px rgba(0,0,0,.2), 0 2px 0 0 rgba(255,255,255,.7) inset;
        color: #333;
        display: inline-block;
        font-family: consolas,"Liberation Mono",courier,monospace;
        font-size: .85em;
        font-weight: 700;
        line-height: 1;
        padding: 2px 4px;
        white-space: nowrap;
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
    
    </style>
  </head>
<body>
    <script src="static/js/jquery-3.5.1.min.js"></script>
    <div class="context">
        <div class="container">
          <form action="/logout" method="POST">
            <h3><label id="welcome"></label> Press <kbd>H</kbd> for help. It's not you?<button type="submit">Log Out</button></h3> 
          <div id="myModal" class="modal">
            <div class="modal-content">
              <div class="modal-header">
                <span class="close">&times;</span>
                <h2>shortcut key</h2>
              </div>
              <div class="modal-body">
                <h4 id="tips1"><kbd>Space</kbd> mark current image as "seen" when you think you have already seen the current image.</h4>
                  <h4 id="tips2"><kbd>S</kbd> start the game. </h4>
                  <h4 id="tips2"><kbd>P</kbd> pause the game. </h4>
                  <h4 id="tips3"><kbd>ESC</kbd> retart the game. </h4>
                  <h4 id="tips3"><kbd>H</kbd> for help. </h4>
              </div>
            </div>
          </div>
            <h1><p id="countdown">Images pre-downloading...</p></h1>
            <h3><label id="progree_count">Image remained: 200</label>
              <progress id="progress" value="0" max="200"></progress>
            </h3>
            <div class="img">
              <img id="image" style="width:600px; align-self:center">
            </div>
        </div>
    </div>  
</body>
   
    <script type=text/javascript>
      $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
      var modal = document.getElementById("myModal");
      var span = document.getElementsByClassName("close")[0];
      var labels = {{labels | tojson}};
      var img_urls = labels.slice(0, labels.length-1);
      var welcome = labels[labels.length-1];
      document.getElementById("welcome").innerHTML = welcome;
      modal.style.display = "block";
      // When the user clicks on <span> (x), close the modal
      span.onclick = function() {
        modal.style.display = "none";
      }

      // When the user clicks anywhere outside of the modal, close it
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }

      answer = -1;
      class Temp {
        addImageProcess(src){
          return new Promise((resolve, reject) => {
            let img = new Image();
            img.onload = () => resolve(img.height);
            img.onerror = reject;
            img.src = src;
          })
        }
      }
      
      let tmp = new Temp();

      image_count = 0;
      let game_start = async function() {
        setTimeout(() => {document.getElementById("countdown").innerHTML = "Game started!";}, 500);
        var y = setInterval(function() {
          $.getJSON($SCRIPT_ROOT + '/img_url', {answer: answer}, function(data) {
            answer = 0;
            image_count++;
            if(image_count<=200) {
              document.body.style.backgroundColor = "#ffe577";
              document.getElementById('image').src = data.url;
              document.getElementById('progress').value = image_count;
              document.getElementById("progree_count").innerHTML = "Image remained: " + (200 - image_count);
            }
            
            // setTimeout(() => {
            //   document.getElementById('image').removeAttribute('src');
            //   // document.getElementById('image').src = "static/blank.png";
            // }, 600);
            });
            if(image_count==200) {
              document.getElementById("countdown").innerHTML = "game ended.";
              $.getJSON($SCRIPT_ROOT + '/img_url', {answer: 3}, {});
              clearInterval(y);
            }
            document.body.onkeyup = function(e){
              modal.style.display = "none";
              if(e.keyCode == 32){
                answer=1;
                document.body.style.backgroundColor = "#ffe8a7";
              }
              if (e.keyCode==27){
                document.getElementById("countdown").innerHTML = "Restarting game...";
                answer = 2;
                image_count = 0;
                game_start();
                clearInterval(y);
              }
              if (e.keyCode==80){
                document.getElementById("countdown").innerHTML = "Game paused and all your progress has been saved!";
                $.getJSON($SCRIPT_ROOT + '/img_url', {answer: 3}, {});
                clearInterval(y);
                document.body.onkeyup = function(e){
                  if (e.keyCode==83){
                    game_start();
                  }
                }
              }
              if (e.keyCode==72){
                modal.style.display = "block";
              }
            }

          }, 1400);
      }
      let images_preload = async function() {
        for (i = 0; i < img_urls.length; i++) {
          await tmp.addImageProcess(img_urls[i]);
        }
        document.getElementById("countdown").innerHTML = "All images are downloaded!"
      }
      images_preload();
      document.body.onkeyup = function(e){
        if (e.keyCode==83){
          document.getElementById("countdown").innerHTML = "The game will start when images downloading finish.";
          game_start();
        }
        if (e.keyCode==27){
          document.getElementById("countdown").innerHTML = "Restarting game...";
          answer = 2;
          image_count = 0;
          game_start();
        }
      }
    </script>